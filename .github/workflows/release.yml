name: Release and Pack

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # 触发条件，当有新tag时运行

jobs:
  pack_and_release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    # 安装jq
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    # 读取配置文件
    - name: Read config file
      id: config
      run: |
        CONFIG=$(cat ./config.json)
        echo "::set-output name=config::$CONFIG"

    # 解析配置文件并转换is_prerelease到布尔值
    - name: Parse config and convert to boolean
      id: parse_config
      run: |
        DIR_TO_PACK=$(echo "${{ steps.config.outputs.config }}" | jq -r '.directory')
        IGNORED_FILES=$(echo "${{ steps.config.outputs.config }}" | jq -r '.ignored_files')
        ZIP_NAME=$(echo "${{ steps.config.outputs.config }}" | jq -r '.zip_name')
        IS_PRERELEASE=$(echo "${{ steps.config.outputs.config }}" | jq -r '.is_prerelease')
        RELEASE_VERSION=$(echo "${{ steps.config.outputs.config }}" | jq -r '.version')
        RELEASE_NOTES=$(echo "${{ steps.config.outputs.config }}" | jq -r '.notes')
        
        # 转换 is_prerelease 到布尔值
        IS_PRERELEASE_BOOL=$(echo "$IS_PRERELEASE" | awk '{print ($0=="true")?"true":"false"}')
        echo "IS_PRERELEASE_BOOL=$IS_PRERELEASE_BOOL" >> $GITHUB_ENV
        echo "DIR_TO_PACK=$DIR_TO_PACK" >> $GITHUB_ENV
        echo "IGNORED_FILES=$IGNORED_FILES" >> $GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
        echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_ENV

    # 打包文件
    - name: Pack files
      run: |
        # 忽略文件列表处理
        IGNORE_FLAGS=""
        for item in $(echo "${{ env.IGNORED_FILES }}" | tr ',' '\n'); do
          IGNORE_FLAGS+=" --exclude='$item'"
        done
        
        # 打包
        zip -r "${{ env.ZIP_NAME }}.zip" ${{ env.DIR_TO_PACK }}$IGNORE_FLAGS

    # 创建或更新Release
    - name: Create or update release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_VERSION }}
        release_name: Release ${{ env.RELEASE_VERSION }}
        body: ${{ env.RELEASE_NOTES }}
        draft: false
        prerelease: ${{ env.IS_PRERELEASE_BOOL }}  # 使用转换后的布尔值

    # 上传压缩包作为资产
    - name: Upload release asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} 
        asset_path: ./${{ env.ZIP_NAME }}.zip
        asset_name: ${{ env.ZIP_NAME }}.zip
        asset_content_type: application/zip